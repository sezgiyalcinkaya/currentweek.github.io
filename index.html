<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realtime Line Chart with Plotly and Firebase</title>
    <!-- Include Plotly.js from CDN -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <!-- Include Firebase JavaScript SDK -->
    <!-- Version 8.10.0 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
    
    
    
    <div id="chart_tvoc_sensor_temperature" class="chart"></div>
    <div id="chart_tvoc_sensor_rh" class="chart"></div>
    <div id="chart_tvoc_sensor_co2" class="chart"></div>
    <div id="chart_light_sensor" class="chart"></div>
    <div id="chart_sound_sensor" class="chart"></div>
    <div id="ChartsHCHO" class="chart"></div>
    <div id="chart_tvoc_sensor_tvoc" class="chart"></div>
    <div id="chart_tvoc_ppm_2_5" class="chart"></div>
    <div id="chart_tvoc_ppm_10" class="chart"></div>
    

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDC1h57a0NiWMT9AXHwKCjj0nuxFvTpGQI",
            authDomain: "nzfl-testing-2.firebaseapp.com",
            databaseURL: "https://nzfl-testing-2-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "nzfl-testing-2",
            storageBucket: "nzfl-testing-2.appspot.com",
            messagingSenderId: "49651777220",
            appId: "1:49651777220:web:8f6827edbdf66cbf231391"
        };
// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const data = firebase.database().ref('device_01');
///////////////////////////////////////////////////////////////////////////////////////////
        
// Function to fetch data and update charts for TVOC sensor TEMPERATURE
function fetchDataAndUpdatechart_tvoc_sensor_temperature() {
            data.once('value')
                .then(snapshot => {
                    const data = snapshot.val();
                    if (!data) {
                        console.error("No data available.");
                        return;
                    }

                    const chartsContainer = document.getElementById('chart_tvoc_sensor_temperature');

                    // Get the start of the most recent week
                    const now = new Date();
                    const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));

                    const recentWeekData = { timestamps: [], tvoc_sensor_temperature_values: [] };

                    for (let key in data) {
                        const timestamp = new Date(parseInt(key) * 1000);

                        // Only include data from the most recent week
                        if (timestamp >= startOfWeek) {
                            recentWeekData.timestamps.push(timestamp.getTime());
                            recentWeekData.tvoc_sensor_temperature_values.push(data[key].tvoc_sensor_temperature);
                        }
                    }

                    // Create chart for the most recent week data
                    createChart(recentWeekData.timestamps, recentWeekData.tvoc_sensor_temperature_values, startOfWeek, chartsContainer, 'Temperature Values');
                })
                .catch(error => {
                    console.error("Error fetching data:", error);
                });
        }
// Function to fetch data and update charts for TVOC sensor CO2
function fetchDataAndUpdatechart_tvoc_sensor_co2() {
            data.once('value')
                .then(snapshot => {
                    const data = snapshot.val();
                    if (!data) {
                        console.error("No data available.");
                        return;
                    }

                    const chartsContainer = document.getElementById('chart_tvoc_sensor_co2');

                    // Get the start of the most recent week
                    const now = new Date();
                    const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));

                    const recentWeekData = { timestamps: [], tvoc_sensor_co2_values: [] };

                    for (let key in data) {
                        const timestamp = new Date(parseInt(key) * 1000);

                        // Only include data from the most recent week
                        if (timestamp >= startOfWeek) {
                            recentWeekData.timestamps.push(timestamp.getTime());
                            recentWeekData.tvoc_sensor_co2_values.push(data[key].tvoc_sensor_co2);
                        }
                    }

                    // Create chart for the most recent week data
                    createChart(recentWeekData.timestamps, recentWeekData.tvoc_sensor_co2_values, startOfWeek, chartsContainer, 'CO2 Sensor');
                })
                .catch(error => {
                    console.error("Error fetching data:", error);
                });
        }
// Function to fetch data and update charts for TVOC sensor RH
function fetchDataAndUpdatechart_tvoc_sensor_rh() {
            data.once('value')
                .then(snapshot => {
                    const data = snapshot.val();
                    if (!data) {
                        console.error("No data available.");
                        return;
                    }

                    const chartsContainer = document.getElementById('chart_tvoc_sensor_rh');

                    // Get the start of the most recent week
                    const now = new Date();
                    const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));

                    const recentWeekData = { timestamps: [], tvoc_sensor_rh_values: [] };

                    for (let key in data) {
                        const timestamp = new Date(parseInt(key) * 1000);

                        // Only include data from the most recent week
                        if (timestamp >= startOfWeek) {
                            recentWeekData.timestamps.push(timestamp.getTime());
                            recentWeekData.tvoc_sensor_rh_values.push(data[key].tvoc_sensor_rh);
                        }
                    }

                    // Create chart for the most recent week data
                    createChart(recentWeekData.timestamps, recentWeekData.tvoc_sensor_rh_values, startOfWeek, chartsContainer, 'Relative Humidity');
                })
                .catch(error => {
                    console.error("Error fetching data:", error);
                });
        }
// Function to fetch data and update charts for TVOC sensor LIGHT
function fetchDataAndUpdatechart_light_sensor() {
            data.once('value')
                .then(snapshot => {
                    const data = snapshot.val();
                    if (!data) {
                        console.error("No data available.");
                        return;
                    }

                    const chartsContainer = document.getElementById('chart_light_sensor');

                    // Get the start of the most recent week
                    const now = new Date();
                    const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));

                    const recentWeekData = { timestamps: [], light_sensor_values: [] };

                    for (let key in data) {
                        const timestamp = new Date(parseInt(key) * 1000);

                        // Only include data from the most recent week
                        if (timestamp >= startOfWeek) {
                            recentWeekData.timestamps.push(timestamp.getTime());
                            recentWeekData.light_sensor_values.push(data[key].light_sensor);
                        }
                    }

                    // Create chart for the most recent week data
                    createChart(recentWeekData.timestamps, recentWeekData.light_sensor_values, startOfWeek, chartsContainer, 'Light Sensor');
                })
                .catch(error => {
                    console.error("Error fetching data:", error);
                });
        }
////////////////////////////////////////////
function fetchDataAndUpdatechart_sound_sensor() {
            data.once('value')
                .then(snapshot => {
                    const data = snapshot.val();
                    if (!data) {
                        console.error("No data available.");
                        return;
                    }

                    const chartsContainer = document.getElementById('chart_sound_sensor');

                    // Get the start of the most recent week
                    const now = new Date();
                    const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));

                    const recentWeekData = { timestamps: [], sound_sensor_values: [] };

                    for (let key in data) {
                        const timestamp = new Date(parseInt(key) * 1000);

                        // Only include data from the most recent week
                        if (timestamp >= startOfWeek) {
                            recentWeekData.timestamps.push(timestamp.getTime());
                            recentWeekData.sound_sensor_values.push(data[key].sound_sensor);
                        }
                    }

                    // Create chart for the most recent week data
                    createChart(recentWeekData.timestamps, recentWeekData.sound_sensor_values, startOfWeek, chartsContainer, 'Sound Sensor');
                })
                .catch(error => {
                    console.error("Error fetching data:", error);
                });
        }
/////////////////////////////////////////////////////////////////////////
function fetchDataAndUpdateChartsHCHO() {
            data.once('value')
                .then(snapshot => {
                    const data = snapshot.val();
                    if (!data) {
                        console.error("No data available.");
                        return;
                    }

                    const chartsContainer = document.getElementById('ChartsHCHO');

                    // Get the start of the most recent week
                    const now = new Date();
                    const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));

                    const recentWeekData = { timestamps: [], ChartsHCHO_values: [] };

                    for (let key in data) {
                        const timestamp = new Date(parseInt(key) * 1000);

                        // Only include data from the most recent week
                        if (timestamp >= startOfWeek) {
                            recentWeekData.timestamps.push(timestamp.getTime());
                            recentWeekData.sChartsHCHO_values.push(data[key].ChartsHCHO);
                        }
                    }

                    // Create chart for the most recent week data
                    createChart(recentWeekData.timestamps, recentWeekData.ChartsHCHO_values, startOfWeek, chartsContainer, 'HCHO Sensor');
                })
                .catch(error => {
                    console.error("Error fetching data:", error);
                });
        }
////////////////////////////////////////////////////////////////////
function fetchDataAndUpdatechart_tvoc_sensor_tvoc() {
            data.once('value')
                .then(snapshot => {
                    const data = snapshot.val();
                    if (!data) {
                        console.error("No data available.");
                        return;
                    }

                    const chartsContainer = document.getElementById('chart_tvoc_sensor_tvoc');

                    // Get the start of the most recent week
                    const now = new Date();
                    const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));

                    const recentWeekData = { timestamps: [], chart_tvoc_sensor_tvoc_values: [] };

                    for (let key in data) {
                        const timestamp = new Date(parseInt(key) * 1000);

                        // Only include data from the most recent week
                        if (timestamp >= startOfWeek) {
                            recentWeekData.timestamps.push(timestamp.getTime());
                            recentWeekData.schart_tvoc_sensor_tvoc_values.push(data[key].chart_tvoc_sensor_tvoc);
                        }
                    }

                    // Create chart for the most recent week data
                    createChart(recentWeekData.timestamps, recentWeekData.chart_tvoc_sensor_tvoc_values, startOfWeek, chartsContainer, 'TVOC Sensor');
                })
                .catch(error => {
                    console.error("Error fetching data:", error);
                });
        }

///////////////////////////////////////////////////////////////////////
function fetchDataAndUpdatechart_tvoc_ppm_2_5() {
            data.once('value')
                .then(snapshot => {
                    const data = snapshot.val();
                    if (!data) {
                        console.error("No data available.");
                        return;
                    }

                    const chartsContainer = document.getElementById('chart_tvoc_ppm_2_5');

                    // Get the start of the most recent week
                    const now = new Date();
                    const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));

                    const recentWeekData = { timestamps: [], chart_tvoc_ppm_2_5_values: [] };

                    for (let key in data) {
                        const timestamp = new Date(parseInt(key) * 1000);

                        // Only include data from the most recent week
                        if (timestamp >= startOfWeek) {
                            recentWeekData.timestamps.push(timestamp.getTime());
                            recentWeekData.schart_tvoc_ppm_2_5_values.push(data[key].chart_tvoc_ppm_2_5);
                        }
                    }

                    // Create chart for the most recent week data
                    createChart(recentWeekData.timestamps, recentWeekData.chart_tvoc_ppm_2_5_values, startOfWeek, chartsContainer, 'TVOC 2.5 Sensor');
                })
                .catch(error => {
                    console.error("Error fetching data:", error);
                });
        }
////////////////////////////////////////////////////////////
function fetchDataAndUpdatechart_tvoc_ppm_10() {
            data.once('value')
                .then(snapshot => {
                    const data = snapshot.val();
                    if (!data) {
                        console.error("No data available.");
                        return;
                    }

                    const chartsContainer = document.getElementById('chart_tvoc_ppm_10');

                    // Get the start of the most recent week
                    const now = new Date();
                    const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));

                    const recentWeekData = { timestamps: [], chart_tvoc_ppm_10_values: [] };

                    for (let key in data) {
                        const timestamp = new Date(parseInt(key) * 1000);

                        // Only include data from the most recent week
                        if (timestamp >= startOfWeek) {
                            recentWeekData.timestamps.push(timestamp.getTime());
                            recentWeekData.schart_tvoc_ppm_10_values.push(data[key].chart_tvoc_ppm_10);
                        }
                    }

                    // Create chart for the most recent week data
                    createChart(recentWeekData.timestamps, recentWeekData.chart_tvoc_ppm_10_values, startOfWeek, chartsContainer, 'TVOC 10 Sensor');
                })
                .catch(error => {
                    console.error("Error fetching data:", error);
                });
        }

        // Function to create a chart for a specific week
        function createChart(timestamps, sensor_values, weekStartTimestamp, chartsContainer, sensor_name) {
            const weekStartDate = new Date(weekStartTimestamp);
            const weekEndDate = new Date(weekStartTimestamp);
            weekEndDate.setDate(weekEndDate.getDate() + 6); // Assuming weeks start on Sunday

            const chartTitle = `${weekStartDate.toLocaleDateString('en-US')} - ${weekEndDate.toLocaleDateString('en-US')}`;
            const chartDiv = document.createElement('div');
            chartsContainer.appendChild(chartDiv);

            // Convert timestamps to day names for x-axis labels
            const xLabels = timestamps.map(timestamp => new Date(timestamp).toLocaleDateString('en-US', { weekday: 'short' }));

            // Filter x-axis labels to show only one label per day
            const filteredXLabels = [];
            let prevDay = '';
            for (let i = 0; i < xLabels.length; i++) {
                const day = xLabels[i];
                if (day !== prevDay) {
                    filteredXLabels.push(day);
                    prevDay = day;
                } else {
                    filteredXLabels.push('');
                }
            }

            // Create hover text with date and time information
            const hoverText = timestamps.map(timestamp => {
                const date = new Date(timestamp);
                return `Date and Time: ${date.toLocaleDateString('en-US')} ${date.toLocaleTimeString('en-US')}`;
            });

            Plotly.newPlot(chartDiv, [{
                x: timestamps,
                y: sensor_values,
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: 'rgb(60, 140, 10)', width: 1 },
                hoverinfo: 'text+y',
                text: hoverText
            }], {
                title: `${sensor_name} - ${chartTitle}`,
                xaxis: {
                    title: 'Date',
                    tickmode: 'array',
                    tickvals: timestamps,
                    ticktext: filteredXLabels
                },
                yaxis: { title: `${sensor_name} Value`}
            });
        }
        //////////////////////////////////////////////////////////////////////////////////////////



        // Call the function to fetch data and update charts for TVOC sensor CO2
        fetchDataAndUpdatechart_tvoc_sensor_temperature();
        fetchDataAndUpdatechart_tvoc_sensor_rh();
        fetchDataAndUpdatechart_tvoc_sensor_co2();
        fetchDataAndUpdatechart_light_sensor();
        fetchDataAndUpdatechart_sound_sensor();
        fetchDataAndUpdateChartsHCHO();
        fetchDataAndUpdatechart_tvoc_sensor_tvoc();
        fetchDataAndUpdatechart_tvoc_ppm_2_5();
        fetchDataAndUpdatechart_tvoc_ppm_10();

    </script>
</body>
</html>
